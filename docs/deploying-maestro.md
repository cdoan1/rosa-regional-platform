# Deploying Maestro to EKS Regional Cluster

Complete guide for deploying Maestro Server to your regional cluster.

## Prerequisites

- ✅ Terraform infrastructure applied (`terraform/config/regional-cluster/`)
- ✅ kubectl configured to access regional cluster (`./scripts/set-kubeconfig.sh regional`)
- ✅ ArgoCD running on the cluster
- ✅ Helm 3.x installed locally
- ✅ AWS Secrets Store CSI Driver installed as EKS addon (deployed automatically by Terraform)

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────┐
│                    Regional EKS Cluster                      │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ AWS Secrets Store CSI Driver (EKS Addon)               │ │
│  │  - Mounts secrets from AWS Secrets Manager as files   │ │
│  │  - Uses Pod Identity for AWS access                   │ │
│  └────────────────────────────────────────────────────────┘ │
│                            ↓                                 │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ Maestro Server (Helm)                                  │ │
│  │  - Reads secrets from mounted files                   │ │
│  │  - MQTT publisher to AWS IoT Core                     │ │
│  │  - HTTP/gRPC API                                       │ │
│  │  - PostgreSQL (RDS) for state                         │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
         │                           │
         ↓                           ↓
  AWS Secrets Manager        AWS IoT Core + RDS
```

---

## Step 1: Generate Maestro Values Override File

The Maestro chart uses two values files:
1. `values.yaml` - Base config (committed to Git, no secrets)
2. `values-override.yaml` - Cluster-specific values (gitignored, NOT committed)

### Run the Populate Script

```bash
# Auto-generate values-override.yaml from Terraform outputs
./scripts/populate-maestro-values.sh
```

**Output:**
```
==============================================================================
Maestro Server Helm Values Population Script
==============================================================================

Step 1: Extracting Terraform outputs...
  - Getting Maestro Server role ARN...
  - Getting MQTT certificate secret name...
  - Getting database credentials secret name...
  - Getting IoT MQTT endpoint...
  ✓ Terraform outputs retrieved successfully

Step 2: Creating values-override.yaml...
  ✓ values-override.yaml created successfully

Step 3: Summary of changes...
  Updated values:
    - aws.podIdentity.roleArn: arn:aws:iam::123456789012:role/regional-us-east-1-maestro-server
    - ascp.mqttCertSecretName: regional-us-east-1/maestro/server-mqtt-cert
    - ascp.dbCredentialsSecretName: regional-us-east-1/maestro/db-credentials
```

### Review the Generated File

```bash
# View the generated override file
cat charts/maestro-server/values-override.yaml
```

**Example contents:**
```yaml
# =============================================================================
# Maestro Server Helm Values Override
# =============================================================================
# This file is generated by scripts/populate-maestro-values.sh
# DO NOT commit this file to Git - it contains cluster-specific values

# AWS Pod Identity - IAM role for Maestro Server
aws:
  podIdentity:
    roleArn: "arn:aws:iam::123456789012:role/regional-us-east-1-maestro-server"

# AWS Secrets Store CSI Driver - Secret names in AWS Secrets Manager
ascp:
  mqttCertSecretName: "regional-us-east-1/maestro/server-mqtt-cert"
  dbCredentialsSecretName: "regional-us-east-1/maestro/db-credentials"
```

**Note:** This file is in `.gitignore` and will never be committed to Git.

---

## Step 2: Deploy Maestro Server (via Helm)

### Install Maestro Server

```bash
# Install using BOTH values files
helm upgrade --install maestro-server ./charts/maestro-server \
  --namespace maestro \
  --create-namespace \
  -f charts/maestro-server/values.yaml \
  -f charts/maestro-server/values-override.yaml
```

**Output:**
```
NAME: maestro-server
LAST DEPLOYED: Mon Jan 20 12:00:00 2026
NAMESPACE: maestro
STATUS: deployed
REVISION: 1
```

### Watch the Deployment

```bash
# Watch pods starting
kubectl get pods -n maestro -w
```

**Expected progression:**
```
NAME                       READY   STATUS            RESTARTS   AGE
maestro-xxx                0/1     Init:0/1          0          5s
maestro-xxx                0/1     PodInitializing   0          20s
maestro-xxx                1/1     Running           0          30s
```

Press `Ctrl+C` to exit watch.

---

## Step 3: Verify Maestro Deployment

### Check All Resources

```bash
# View all resources in maestro namespace
kubectl get all -n maestro
```

**Expected output:**
```
NAME                           READY   STATUS    RESTARTS   AGE
pod/maestro-xxx                1/1     Running   0          2m
pod/maestro-yyy                1/1     Running   0          2m

NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
service/maestro-grpc      ClusterIP   10.100.x.x       <none>        8090/TCP   2m
service/maestro-health    ClusterIP   10.100.x.x       <none>        8083/TCP   2m
service/maestro-http      ClusterIP   10.100.x.x       <none>        8080/TCP   2m
service/maestro-metrics   ClusterIP   10.100.x.x       <none>        8080/TCP   2m

NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/maestro   2/2     2            2           2m
```

### Verify SecretProviderClass

```bash
# Check SecretProviderClass was created
kubectl get secretproviderclass -n maestro
```

**Expected output:**
```
NAME                    AGE
maestro-server-secrets  2m
```

### Check Maestro Pod Logs

```bash
# View recent logs from Maestro pods
kubectl logs -n maestro -l app=maestro --tail=50
```

**Look for:**
- Database connection successful
- MQTT broker connection successful
- HTTP server started on port 8080
- gRPC server started on port 8090

**No errors about:**
- Failed to connect to database
- Failed to load secrets
- MQTT connection errors

### Verify Secrets are Mounted

```bash
# Check that secrets are mounted in the pod
kubectl exec -n maestro deployment/maestro -c service -- ls -la /mnt/secrets-store
```

**Expected output:**
```
total 24
drwxrwxrwt 3 root root  140 Jan 21 15:00 .
drwxr-xr-x 1 root root   30 Jan 21 15:00 ..
-rw-r--r-- 1 root root 1234 Jan 21 15:00 ca.crt
-rw-r--r-- 1 root root 1675 Jan 21 15:00 certificate
-rw-r--r-- 1 root root   20 Jan 21 15:00 db.host
-rw-r--r-- 1 root root   10 Jan 21 15:00 db.name
-rw-r--r-- 1 root root   32 Jan 21 15:00 db.password
-rw-r--r-- 1 root root    4 Jan 21 15:00 db.port
-rw-r--r-- 1 root root   13 Jan 21 15:00 db.user
-rw-r--r-- 1 root root 1679 Jan 21 15:00 privateKey
```

### Check Pod Details

```bash
# Describe pod for detailed status
kubectl describe pod -n maestro -l app=maestro
```

**Look for:**
- `Status: Running`
- No errors in Events section
- All containers ready
- Volume mount for `secrets-store` present

---

## Step 4: Test Maestro Health Endpoint

### Port-Forward to Health Service

```bash
# Forward local port 8083 to Maestro health service
kubectl port-forward -n maestro svc/maestro-health 8083:8083 &
```

### Test Health Endpoint

```bash
# Check health endpoint
curl http://localhost:8083/healthcheck
```

**Expected response:**
```json
{
  "status": "healthy"
}
```

Or similar healthy status response.

### Cleanup Port-Forward

```bash
# Kill the port-forward process
pkill -f "port-forward.*8083"
```

---

## Complete One-Liner Deployment

If you want to run all steps in sequence:

```bash
# Generate values and deploy Maestro
./scripts/populate-maestro-values.sh && \
helm upgrade --install maestro-server ./charts/maestro-server \
  --namespace maestro \
  --create-namespace \
  -f charts/maestro-server/values.yaml \
  -f charts/maestro-server/values-override.yaml && \
kubectl get pods -n maestro -w
```

---

## Troubleshooting

### Maestro Pods Failing to Start

**Check pod status:**
```bash
kubectl get pods -n maestro
kubectl describe pod -n maestro -l app=maestro
```

**Common issues:**
- `SecretProviderClass not found` - Check if ASCP CSI Driver addon is installed
- `Failed to mount secrets` - Check Pod Identity and IAM role permissions

**Verify ASCP CSI Driver addon:**
```bash
# Should show aws-secrets-store-csi-driver
kubectl get csidriver
```

### Secrets Not Mounting

**Check SecretProviderClass:**
```bash
kubectl describe secretproviderclass maestro-server-secrets -n maestro
```

**Check Pod Identity annotation:**
```bash
kubectl get serviceaccount maestro-server -n maestro -o yaml | grep eks.amazonaws.com/role-arn
```

**Check IAM role exists:**
```bash
cd terraform/config/regional-cluster
terraform output maestro_server_role_arn
```

### Database Connection Failed

**Check logs:**
```bash
kubectl logs -n maestro -l app=maestro --tail=100
```

**Common issues:**
- `Secrets not found` - ASCP not mounting secrets correctly
- `Database connection failed` - RDS not accessible or credentials wrong
- `Init container failed` - Database migration failed

**Check database connection from pod:**
```bash
# Get DB secret values
kubectl exec -n maestro deployment/maestro -c service -- cat /mnt/secrets-store/db.host
kubectl exec -n maestro deployment/maestro -c service -- cat /mnt/secrets-store/db.port

# Test connection
kubectl run -it --rm debug -n maestro --image=postgres:16 --restart=Never -- \
  psql -h <host-from-above> -p <port-from-above> -U maestro_admin -d maestro -c "SELECT version();"
```

### MQTT Connection Failed

**Check ASCP mounted MQTT certificates:**
```bash
kubectl exec -n maestro deployment/maestro -c service -- ls -la /mnt/secrets-store | grep -E "(certificate|privateKey|ca.crt)"
```

**Check IoT endpoint in ConfigMap:**
```bash
kubectl get configmap maestro-mqtt-config -n maestro -o yaml
```

### Helm Install Fails

**Values override not found:**
```bash
# Regenerate the override file
./scripts/populate-maestro-values.sh
```

**Empty roleArn errors:**
```bash
# Make sure you're using BOTH values files
helm upgrade --install maestro-server ./charts/maestro-server \
  -f charts/maestro-server/values.yaml \
  -f charts/maestro-server/values-override.yaml
```

**SecretProviderClass errors:**
```bash
# Verify ASCP CSI Driver is installed
kubectl get daemonset -n kube-system | grep secrets-store
```

### Start Over (Clean Slate)

```bash
# Uninstall Maestro
helm uninstall maestro-server -n maestro

# Delete namespace
kubectl delete namespace maestro

# Start from Step 1
```

---

## How It Works

### AWS Secrets Store CSI Driver (ASCP)

The ASCP CSI Driver is installed as an EKS addon by Terraform and runs as a DaemonSet in the `kube-system` namespace.

**Key Features:**
- Mounts AWS Secrets Manager secrets directly as files in pods
- Uses Pod Identity for authentication (no IRSA/OIDC needed)
- Secrets are never stored as Kubernetes Secret objects
- Automatic secret rotation support

**Architecture:**
```
Pod with volume mount
    ↓
SecretProviderClass (defines what secrets to mount)
    ↓
ASCP CSI Driver DaemonSet
    ↓
AWS Pod Identity → AssumeRole
    ↓
AWS Secrets Manager → GetSecretValue
    ↓
Secrets mounted as files in pod
```

### Secret Mounting Process

1. **Helm chart creates** `SecretProviderClass` resource specifying:
   - Secret names in AWS Secrets Manager
   - Field mappings (e.g., `username` → `db.user`)
   - Pod Identity authentication

2. **Pod starts** with volume mount referencing the `SecretProviderClass`

3. **ASCP CSI Driver**:
   - Uses Pod Identity to assume the IAM role
   - Calls `GetSecretValue` on AWS Secrets Manager
   - Extracts fields using jmesPath
   - Mounts secrets as individual files

4. **Maestro application** reads secrets from `/mnt/secrets-store/` files

---

## Next Steps

After successful deployment:

1. **Test MQTT Connectivity**
   - Verify Maestro can publish to AWS IoT Core
   - Check CloudWatch Logs for IoT messages

2. **Deploy Maestro Agent**
   - Deploy agent to management cluster
   - Test ManifestWork propagation

3. **Monitor Performance**
   - Check Prometheus metrics (if enabled)
   - Monitor RDS performance
   - Watch CloudWatch Logs

4. **Production Readiness**
   - Enable RDS Multi-AZ (`maestro_db_multi_az = true`)
   - Enable deletion protection (`maestro_db_deletion_protection = true`)
   - Add PodDisruptionBudget
   - Enable HorizontalPodAutoscaler
   - Configure ServiceMonitor for Prometheus

---

## Quick Reference Commands

```bash
# Check Maestro status
kubectl get pods -n maestro
kubectl get secretproviderclass -n maestro
kubectl get serviceaccount -n maestro

# View logs
kubectl logs -n maestro -l app=maestro --tail=50 -f

# Check mounted secrets
kubectl exec -n maestro deployment/maestro -c service -- ls -la /mnt/secrets-store

# Restart Maestro
kubectl rollout restart deployment maestro -n maestro

# Upgrade Maestro with new values
helm upgrade maestro-server ./charts/maestro-server \
  -f charts/maestro-server/values.yaml \
  -f charts/maestro-server/values-override.yaml

# Uninstall
helm uninstall maestro-server -n maestro
```
